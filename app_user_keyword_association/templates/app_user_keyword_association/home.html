{% extends 'base.html' %} 
{% block title %}全文檢索與你關心的關鍵詞關聯分析{% endblock %} 

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="content-card mb-4">
      <h1 class="mb-3">全文檢索與你關心的關鍵詞關聯分析</h1>
      <p class="lead">對你想要了解的議題進行全文檢索，找出有哪些詞與你的關鍵詞一起出現?</p>
    </div>
  </div>

  <div class="col-lg-6 mb-4">
    <!-- 輸入條件區塊開始 -->
    <div class="content-card">
      <div class="card-header bg-white text-black">
        <h3 class="h5 text-uppercase mb-0">
          <i class="fas fa-search me-2"></i>輸入條件
        </h3>
      </div>
      <p></p>
      <div class="card-body">
        <div class="row mb-3">
          <label class="col-md-3 col-form-label text-md-end">
            <i class="fas fa-key me-2"></i>關心的關鍵詞?
          </label>
          <div class="col-md-9">
            <input id="input_keyword" name="userkey" value="緬甸 地震" class="form-control" />
            <div class="form-text text-muted">
              全文搜尋，可輸入多個關鍵詞或片段詞句，以空白隔開。
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-3 col-form-label text-md-end">
            <i class="fas fa-filter me-2"></i>條件
          </label>

          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="and" name="condradio" id="condradio1" checked />
              <label class="form-check-label" for="condradio1">and</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="or" name="condradio" id="condradio2" />
              <label class="form-check-label" for="condradio2">or</label>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-sm-3 col-form-label text-md-end">
            <i class="fas fa-newspaper me-2"></i>新聞類別
          </label>
          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="全部" name="cateradio" id="cateradio1" checked />
              <label class="form-check-label" for="cateradio1">全部</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="政治" name="cateradio" id="cateradio2" />
              <label class="form-check-label" for="cateradio2">政治</label>
            </div>
            
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="運動" name="cateradio" id="cateradio4" />
              <label class="form-check-label" for="cateradio4">運動</label>
            </div>
            
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="娛樂" name="cateradio" id="cateradio7" />
              <label class="form-check-label" for="cateradio7">娛樂</label>
            </div>
           
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="國際" name="cateradio" id="cateradio9" />
              <label class="form-check-label" for="cateradio9">國際</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="地方" name="cateradio" id="cateradio10" />
              <label class="form-check-label" for="cateradio10">地方</label>
            </div>
            
          </div>
        </div>
        <div class="row mb-3">
          <label class="col-md-3 col-form-label text-md-end">
            <i class="fas fa-calendar-alt me-2"></i>最近多少周?
          </label>
          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="1" name="wkradio" id="wkradio1" />
              <label class="form-check-label" for="wkradio1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="2" name="wkradio" id="wkradio2" checked />
              <label class="form-check-label" for="wkradio2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="3" name="wkradio" id="wkradio3" />
              <label class="form-check-label" for="wkradio3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="4" name="wkradio" id="wkradio4" />
              <label class="form-check-label" for="wkradio4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="6" name="wkradio" id="wkradio6" />
              <label class="form-check-label" for="wkradio6">6</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="8" name="wkradio" id="wkradio8" />
              <label class="form-check-label" for="wkradio8">8</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" value="12" name="wkradio" id="wkradio12" />
              <label class="form-check-label" for="wkradio12">12</label>
            </div>
            <div class="form-text text-muted">
              以最新資料時間為準，往前推多少周?
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-9 ms-auto">
            <button type="button" id="btn_ok" class="btn btn-primary">
              <i class="fas fa-search me-2"></i>查詢
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 輸入區塊結束-->

  <!-- 繪圖區塊-->
  <div class="col-lg-6 mb-4">
    <div class="content-card">
      <div class="card-header bg-white text-black">
        <h3 class="h5 text-uppercase mb-0">
          <i class="fas fa-cloud me-2"></i>這些詞與它同時出現喔!
        </h3>
      </div>
      <p></p>
      <div class="card-body">
        <!-- Set fixed dimensions for the cloud container -->
        <div id="cloud" style="height: 390px; width: 100%; position: relative;"></div>
      </div>
    </div>
  </div>
  <!-- 區塊結束-->

  <!-- 新聞連結區塊-->
  <div class="col-lg-6 mb-4">
    <div class="content-card">
      <div class="card-header bg-white text-black">
        <h3 class="h5 text-uppercase mb-0">
          <i class="fas fa-newspaper me-2"></i>以下新聞與它有關(取數篇展示)
        </h3>
      </div>
      <p></p>
      <div class="card-body">
        <h2 id="num_articles" class="text-center mb-3"></h2>
        <ul class="list-group" id="newslinks"></ul>
      </div>
    </div>
  </div>
  <!-- 區塊結束-->

  <!-- 同時出現的關鍵字區塊-->
  <div class="col-lg-6 mb-4">
    <div class="content-card">
      <div class="card-header bg-white text-black">
        <h3 class="h5 text-uppercase mb-0">
          <i class="fas fa-paragraph me-2"></i>關鍵字所在的段落(取數段展示)
        </h3>
      </div>
      <p></p>
      <div class="card-body">
        <!-- 這個標籤顯示頁碼 -->
        <ul class="list-group" id="same_paragraph"></ul>
      </div>
    </div>
  </div>
  <!-- 區塊結束-->

  <!-- 同時出現的關鍵字區塊-->
  <div class="col-lg-6 mb-4">
    <div class="content-card">
      <div class="card-header bg-white text-black">
        <h3 class="h5 text-uppercase mb-0">
          <i class="fas fa-link me-2"></i>與它同時出現的關鍵字
        </h3>
      </div>
      <p></p>
      <div class="card-body">
        <ul id="related_words" class="list-group"></ul>
      </div>
    </div>
  </div>
  <!-- 區塊結束-->
</div>
{% endblock %} 

{% block extra_js %}
<!-- chartjs-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>

<!-- cloud chart -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
<script src="https://cdn.rawgit.com/jasondavies/d3-cloud/v1.2.1/build/d3.layout.cloud.js"></script>

<!-- Here are your codes -->
<script>
  // Show the page with default setting when page is initialized.
  call_ajax();

  // btn submit
  $("#btn_ok").on("click", function () {
    call_ajax();
  }); //event function

  // category radio button
  $("input[name='cateradio']").on("change", function () {
    call_ajax();
  }); //event function

  // weeks radio button
  $("input[name='wkradio']").on("change", function () {
    call_ajax();
  }); //event function

  // condition radio button
  $("input[name='condradio']").on("change", function () {
    call_ajax();
  }); //event function

  function call_ajax() {
    const userkey = $("#input_keyword").val();
    const weeks = $("input[name='wkradio']:checked").val();
    const cate = $("input[name='cateradio']:checked").val();
    const cond = $("input[name='condradio']:checked").val();

    if (userkey.length < 2) {
      alert("輸入關鍵字不可空白或小於兩個中文字!");
      return 0;
    }
    $.ajax({
      type: "POST",
      url: "api_get_userkey_associate/",
      data: {
        userkey: userkey,
        cate: cate,
        weeks: weeks,
        cond: cond,
      }, // pass to server
      success: function (received) {
        
        // display number of articles or stories
        const num_articles = received["num_articles"];
        $("#num_articles").empty();
        $("#num_articles").append("<h2 style='color:#3498db;'><i class='fas fa-chart-line me-2'></i>總篇數: " + num_articles + "</h2>");
        
        // show news title and link
        const newslinks = received["newslinks"];
        $("#newslinks").empty();
        if (newslinks.length == 0) {
          alert("No result returned!");
        }
        // show news title and link
        for (let i = 0; i < newslinks.length; i++) {
          const items =
            '<li class="list-group-item py-2 border-bottom">' +
            '<div class="d-flex align-items-center">' +
            '<span class="badge bg-secondary me-2 px-2 py-1">' + newslinks[i].category + '</span>' +
            '<a href="' + newslinks[i].link + '" class="text-decoration-none" target="_blank">' +
            newslinks[i].title +
            '</a>' +
            '</div>' +
            '</li>';
          $("#newslinks").append(items);
        }

        // show related words
        const related_words = received["related_words"];
        $("#related_words").empty();
        for (let i = 0; i < related_words.length; i++) {
          const items = '<li class="list-group-item d-flex justify-content-between align-items-center">' + 
                        related_words[i] + 
                        '<span class="badge bg-primary rounded-pill">' + (i+1) + '</span></li>';
          $("#related_words").append(items);
        }

        // show paragraphs containing the user keywords
        const same_paragraph = received["same_paragraph"];
        $("#same_paragraph").empty();

        for (let i = 0; i < same_paragraph.length; i++) {
          const msg = "<li class='list-group-item py-2 border-bottom'>" + same_paragraph[i] + "</li>";
          $("#same_paragraph").append(msg);
        }

        // draw word cloud for related words
        topWordToDraw = received.clouddata;
        $("#cloud").empty();
        drawCloud(topWordToDraw, "#cloud");
      }, //success function

      error: function (msg, status) {
        console.log(msg);
        console.log(status);
      }, //print status and msg when ajax goes wrong
    }); //ajax
  } //function call_ajax()


  function drawCloud(topWordToDraw, element_id) {
  // Set fixed dimensions for the cloud
  const width = 380;
  const height = 380;

  // Normalize sizes to prevent extreme values
  if (topWordToDraw.length > 0) {
    const maxSize = Math.max(...topWordToDraw.map(d => d.size));
    const minSize = Math.min(...topWordToDraw.map(d => d.size));
    
    // Adjust the size scale to prevent words from being too large
    const maxFontSize = 60; // Maximum font size
    const minFontSize = 14; // Minimum font size
    
    // Normalize sizes
    topWordToDraw = topWordToDraw.map(d => {
      // Create a more balanced size distribution
      let normalizedSize = minFontSize;
      if (maxSize !== minSize) {
        normalizedSize = minFontSize + ((d.size - minSize) / (maxSize - minSize)) * (maxFontSize - minFontSize);
      }
      return {
        text: d.text,
        size: normalizedSize
      };
    });
  }

  // Create word cloud layout
  d3.layout
    .cloud()
    .size([width, height])
    .words(topWordToDraw)
    .padding(5) // Add padding between words
    .rotate(function() {
      return 0; // Don't rotate for better readability
    })
    .font("'Noto Sans TC', sans-serif") // Use the same font as the site
    .fontSize(function(d) {
      return d.size;
    })
    .on("end", draw)
    .start();

  // Draw the word cloud
  function draw(words) {
    // Use a more visually appealing color scheme
    const colorScheme = [
      "#3498db", "#2ecc71", "#9b59b6", "#e74c3c", "#f1c40f",
      "#1abc9c", "#e67e22", "#95a5a6", "#f39c12", "#34495e"
    ];
    
    // Clear previous cloud
    d3.select(element_id).html("");
    
    // Create the SVG container
    d3.select(element_id)
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", `0 0 ${width} ${height}`)
      .attr("preserveAspectRatio", "xMidYMid meet") // Ensure proper scaling
      .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
      .selectAll("text")
      .data(words)
      .enter()
      .append("text")
      .style("font-size", function(d) {
        return d.size + "px";
      })
      .style("font-family", "'Noto Sans TC', sans-serif")
      .style("font-weight", function(d) {
        // Make larger words bolder
        return d.size > 30 ? "bold" : "normal";
      })
      .style("-webkit-touch-callout", "none")
      .style("-webkit-user-select", "none")
      .style("-khtml-user-select", "none")
      .style("-moz-user-select", "none")
      .style("-ms-user-select", "none")
      .style("user-select", "none")
      .style("cursor", "pointer")
      .style("fill", function(d, i) {
        // Use our color scheme
        return colorScheme[i % colorScheme.length];
      })
      .attr("text-anchor", "middle")
      .attr("transform", function(d) {
        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
      })
      .text(function(d) {
        return d.text;
      })
      .on("mouseover", function() {
        // Simple hover effect
        d3.select(this)
          .transition()
          .duration(200)
          .style("font-size", function(d) {
            return (d.size + 2) + "px";
          });
      })
      .on("mouseout", function() {
        d3.select(this)
          .transition()
          .duration(200)
          .style("font-size", function(d) {
            return d.size + "px";
          });
      });
  }
}
</script>
{% endblock %}